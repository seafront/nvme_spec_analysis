











**Virtualization Management command**


The Virtualization Management command is supported by primary controllers that support the Virtualization
Enhancements capability. This command is used for several functions:


  - Modifying Flexible Resource allocation for the primary controller;

  - Assigning Flexible Resources for secondary controllers; and

  - Setting the Online and Offline state for secondary controllers.


Refer to section 8.2.6 for more on the Virtualization Enhancements capability and the Virtualization
Management command.


The Virtualization Management command uses the Command Dword 10 and Command Dword 11 fields.
All other command specific fields are reserved.


If the action requested specifies a range of controller resources that:


a) does not exist;
b) is a Private Resource (e.g., VQ resources are requested when VQ resources are not supported, VI

resources are requested when VI resources are not supported); or
c) is currently in use (e.g., the number of Controller Resources (NR) is greater than the number of

remaining available flexible resources),


then the command is aborted with a status code of Invalid Resource Identifier.


421


NVM Express [®] Base Specification, Revision 2.2


**Figure 490: Virtualization Management – Command Dword 10**


|Value|Definition|
|---|---|
|000b|**VQ Resources**|
|001b|**VI Resources**|
|010b to 111b|Reserved|









|Bits|Description|
|---|---|
|31:16|**Controller Identifier (CNTLID):** This field indicates the controller for which controller resources are to be<br>modified.|
|15:11|Reserved|
|10:08|**Resource Type (RT):** This field indicates the type of controller resource to be modified.<br>**Value**<br>**Definition**<br>000b<br>**VQ Resources** <br>001b<br>**VI Resources** <br>010b to 111b<br>Reserved|
|07:04|Reserved|
|03:00|**Action (ACT):**This field indicates the operation for the command to perform as described below.<br>**Value**<br>**Definition**<br>0h<br>Reserved<br>1h<br>**Primary Controller Flexible Allocation:** Set the number of Flexible Resources<br>allocated to this primary controller following the next Controller Level Reset other than a<br>Controller Reset. If the Controller Identifier field does not correspond to this primary<br>controller, then a status code of Invalid Controller Identifier is returned. This value is<br>persistent across power cycles and resets.<br>2h to 6h<br>Reserved<br>7h<br>**Secondary Controller Offline:** Place the secondary controller in the Offline state and<br>remove all Flexible Resources. If the Controller Identifier field does not correspond to a<br>secondary controller associated with this primary controller, then a status code of Invalid<br>Controller Identifier is returned.<br>It is not an error to request a secondary controller be placed in the offline state if that<br>secondary controller is already in the offline state. <br>8h<br>**Secondary Controller Assign:** Assign the number of controller resources specified in<br>Number of Controller Resources to the secondary controller. If the Controller Identifier<br>field does not correspond to a secondary controller associated with this primary<br>controller, then an error of Invalid Controller Identifier is returned. If the secondary<br>controller is not in the Offline state, then a status code of Invalid Secondary Controller<br>State is returned. <br>9h<br>**Secondary Controller Online:** Place the secondary controller in the Online state. If the<br>Controller Identifier field does not correspond to a secondary controller associated with<br>this primary controller, then an error of Invalid Controller Identifier is returned. If the<br>secondary controller is not configured appropriately (refer to section 8.2.6) or the primary<br>controller is not enabled, then a status code of Invalid Secondary Controller State is<br>returned.<br>It is not an error to request a secondary controller be placed in the online state if that<br>secondary controller is already in the online state.<br>Ah to Fh<br>Reserved|


|Value|Definition|
|---|---|
|0h|Reserved|
|1h|**Primary Controller Flexible Allocation:** Set the number of Flexible Resources<br>allocated to this primary controller following the next Controller Level Reset other than a<br>Controller Reset. If the Controller Identifier field does not correspond to this primary<br>controller, then a status code of Invalid Controller Identifier is returned. This value is<br>persistent across power cycles and resets.|
|2h to 6h|Reserved|
|7h|**Secondary Controller Offline:** Place the secondary controller in the Offline state and<br>remove all Flexible Resources. If the Controller Identifier field does not correspond to a<br>secondary controller associated with this primary controller, then a status code of Invalid<br>Controller Identifier is returned.<br>It is not an error to request a secondary controller be placed in the offline state if that<br>secondary controller is already in the offline state.|
|8h|**Secondary Controller Assign:** Assign the number of controller resources specified in<br>Number of Controller Resources to the secondary controller. If the Controller Identifier<br>field does not correspond to a secondary controller associated with this primary<br>controller, then an error of Invalid Controller Identifier is returned. If the secondary<br>controller is not in the Offline state, then a status code of Invalid Secondary Controller<br>State is returned.|
|9h|**Secondary Controller Online:** Place the secondary controller in the Online state. If the<br>Controller Identifier field does not correspond to a secondary controller associated with<br>this primary controller, then an error of Invalid Controller Identifier is returned. If the<br>secondary controller is not configured appropriately (refer to section 8.2.6) or the primary<br>controller is not enabled, then a status code of Invalid Secondary Controller State is<br>returned.<br>It is not an error to request a secondary controller be placed in the online state if that<br>secondary controller is already in the online state.|
|Ah to Fh|Reserved|


**Figure 491: Virtualization Management – Command Dword 11**

|Bits|Description|
|---|---|
|31:16|Reserved|
|15:00|**Number of Controller Resources (NR):** This field indicates a number of controller resources to allocate<br>or assign.|



**Command Completion**


Command specific status values associated with the Virtualization management command are defined in
Figure 492.


422


NVM Express [®] Base Specification, Revision 2.2


**Figure 492: Virtualization Management – Command Specific Status Values**






|Value|Definition|
|---|---|
|1Fh|**Invalid Controller Identifier:**An invalid Controller Identifier was specified.|
|20h|**Invalid Secondary Controller State:** The action requested for the secondary controller is invalid<br>based on the current state of the secondary controller and its primary controller.|
|21h|**Invalid Number of Controller Resources:** The specified number of Flexible Resources is invalid<br>(e.g., the Number of Controller Resources (NR) is greater than VQ Resources Flexible Total<br>(VQFRT) (refer to Figure 331), the Number of Controller Resources (NR) is greater than VQ<br>Resources Flexible Secondary Maximum (VQFRSM) (refer to Figure 331)).|
|22h|**Invalid Resource Identifier:** At least one of the specified resource identifiers was invalid (e.g., the<br>Number of Controller Resources (NR) is greater than the number of remaining available flexible<br>resources).|



Dword 0 of the completion queue entry contains information about the controller resources that were
modified as part of the Primary Controller Flexible Allocation and Secondary Controller Assign actions.
Dword 0 of the completion queue entry is defined in Figure 493.


**Figure 493: Virtualization Management – Completion Queue Entry Dword 0**

|Bits|Description|
|---|---|
|31:16|Reserved|
|15:00|**Number of Controller Resources Modified (NRM):** This field indicates the number of controller resources<br>that were allocated or assigned. The value may be smaller or larger than the number requested.|

