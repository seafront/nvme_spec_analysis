
**Capacity Management command**


Host software uses the Capacity Management command to configure Endurance Groups and NVM Sets in
an NVM subsystem by either selecting one of a set of supported configurations (i.e., Fixed Capacity


178


NVM Express [®] Base Specification, Revision 2.2


Management; refer to section 8.1.4.2) or by specifying the capacity of the Endurance Group or NVM Set to
be created (i.e., Variable Capacity Management; refer to section 8.1.4.3). The Capacity Management
command specifies the operations defined in Figure 157.


The Capacity Management command uses the Command Dword 10, Command Dword 11, and Command
Dword 12 fields. All other command specific fields are reserved.


For requirements to support the operations in Figure 157, refer to section 8.1.4.


**Figure 157: Capacity Management – Command Dword 10**











|Bits|Description|
|---|---|
|31:16|**Element Identifier (ELID):** This field contains a value specific to the value of the Operation field.1|
|15:04|Reserved|
|03:00|**Operation (OPER):**Specifies the operation to be performed by the controller:<br>**Value**<br>**Definition**<br>**Element Identifier Field**<br>0h<br>**Select**<br>**Capacity**<br>**Configuration:** <br>Endurance<br>Groups and NVM Sets are configured as indicated<br>by the Capacity Configuration Descriptor specified<br>by this command (refer to section 5.1.3.1). <br>Capacity Configuration Identifier (refer<br>to Figure 258).<br>1h<br>**Create Endurance Group:** An Endurance Group<br>is created (refer to section 8.1.4.3) with the capacity<br>specified by the Capacity Lower field (refer to<br>Figure 158) and the Capacity Upper field (refer to<br>Figure 159).<br>Domain Identifier (refer to section<br>3.2.5.3) of the domain in which the<br>Endurance Group is to be created. A<br>value of 0h specifies that the controller<br>selects the domain in which the<br>Endurance Group is created.<br>2h<br>**Delete Endurance Group:** The Endurance Group<br>specified by this command is deleted (refer to<br>section 8.1.4.3). All namespaces and NVM Sets<br>contained by the Endurance Group are deleted. <br>Endurance Group Identifier of the<br>Endurance Group to be deleted.<br>3h<br>**Create NVM Set:** An NVM Set is created (refer to<br>section 8.1.4.3) in the specified Endurance Group<br>with the capacity specified by the Capacity Lower<br>field and the Capacity Upper field.<br>If the controller does not support NVM Sets, then<br>this operation is not supported.<br>Endurance Group Identifier of the<br>Endurance Group in which the NVM<br>Set is to be created. A value of 0h<br>specifies that the controller selects the<br>Endurance Group in which the NVM<br>Set is created.<br>4h<br>**Delete NVM Set:** The NVM Set specified by this<br>command is deleted (refer to section 8.1.4.3). All<br>namespaces in the NVM Set are deleted.<br>If the controller does not support NVM Sets, then<br>this operation is not supported.<br>NVM Set identifier of the NVM Set to be<br>deleted.<br>5h to Fh<br>Reserved<br>|
|Notes:<br>1.<br>If the Element Identifier field specifies a non-zero value which does not correspond to an existing capacity entity,<br>then the controller shall abort the command with a status code of Invalid Field in Command.|Notes:<br>1.<br>If the Element Identifier field specifies a non-zero value which does not correspond to an existing capacity entity,<br>then the controller shall abort the command with a status code of Invalid Field in Command.|


|Value|Definition|Element Identifier Field|
|---|---|---|
|0h|**Select**<br>**Capacity**<br>**Configuration:** <br>Endurance<br>Groups and NVM Sets are configured as indicated<br>by the Capacity Configuration Descriptor specified<br>by this command (refer to section 5.1.3.1).|Capacity Configuration Identifier (refer<br>to Figure 258).|
|1h|**Create Endurance Group:** An Endurance Group<br>is created (refer to section 8.1.4.3) with the capacity<br>specified by the Capacity Lower field (refer to<br>Figure 158) and the Capacity Upper field (refer to<br>Figure 159).|Domain Identifier (refer to section<br>3.2.5.3) of the domain in which the<br>Endurance Group is to be created. A<br>value of 0h specifies that the controller<br>selects the domain in which the<br>Endurance Group is created.|
|2h|**Delete Endurance Group:** The Endurance Group<br>specified by this command is deleted (refer to<br>section 8.1.4.3). All namespaces and NVM Sets<br>contained by the Endurance Group are deleted.|Endurance Group Identifier of the<br>Endurance Group to be deleted.|
|3h|**Create NVM Set:** An NVM Set is created (refer to<br>section 8.1.4.3) in the specified Endurance Group<br>with the capacity specified by the Capacity Lower<br>field and the Capacity Upper field.<br>If the controller does not support NVM Sets, then<br>this operation is not supported.|Endurance Group Identifier of the<br>Endurance Group in which the NVM<br>Set is to be created. A value of 0h<br>specifies that the controller selects the<br>Endurance Group in which the NVM<br>Set is created.|
|4h|**Delete NVM Set:** The NVM Set specified by this<br>command is deleted (refer to section 8.1.4.3). All<br>namespaces in the NVM Set are deleted.<br>If the controller does not support NVM Sets, then<br>this operation is not supported.|NVM Set identifier of the NVM Set to be<br>deleted.|
|5h to Fh|Reserved||


**Figure 158: Capacity Management – Command Dword 11**

|Bits|Description|
|---|---|
|31:00|**Capacity Lower (CAPL):** This field specifies the least significant 32 bits of the capacity in bytes of the<br>Endurance Group or NVM Set to be created.|



**Figure 159: Capacity Management – Command Dword 12**

|Bits|Description|
|---|---|
|31:00|**Capacity Upper (CAPU):** This field specifies the most significant 32 bits of the capacity in bytes of the<br>Endurance Group or NVM Set to be created.|



179


NVM Express [®] Base Specification, Revision 2.2


If the Operation field specifies the Create Endurance Group operation or the Create NVM Set operation,
then the Capacity Upper and Capacity Lower fields specify the capacity of the Endurance Group or NVM
Set to be created. If the Operation field specifies any other operation, then the Capacity Upper field and the
Capacity Lower field are reserved.


**Media Unit Configuration Selection**


If:


a) the Operation field specifies the Select Capacity Configuration operation;
b) the Element Identifier field specifies a Capacity Configuration Descriptor in the Supported Capacity

Configuration List; and
c) the Selected Configuration field of the Media Unit Status log page (refer to Figure 255) is cleared

to 0h,


then the controller shall perform all of the following actions in sequence:


1) Create an Endurance Group for each Endurance Group Configuration Descriptor in the selected

Capacity Configuration Descriptor.
2) Create an NVM Set for each NVM Set Identifier specified in each Endurance Group Configuration

Descriptor, if any.


If the Operation field specifies the Select Capacity Configuration operation and the Element Identifier field
is cleared to ‘0’, then the controller shall clear the configuration by performing all of the following actions in

sequence:


1) Delete all namespaces in the domain that contains the controller processing the command, as

described in section 8.1.15.
2) Delete all NVM Sets in the domain that contains the controller processing the command, if any.
3) Delete all Endurance Groups in the domain that contains the controller processing the command.
4) Clear the Selected Configuration field to 0h in the Media Unit Status log page.


If the Operation field specifies the Select Capacity Configuration operation and the Element Identifier field
specifies the value reported in the Selected Configuration field of the Media Unit Status log page (i.e., the
currently-selected configuration), then the controller shall complete the command without error and shall
make no change to the capacity configuration.


If the Operation field specifies the Select Capacity Configuration operation and:


a) the Element Identifier field does not specify either a value of 0h or the Capacity Configuration

Identifier of a Capacity Configuration Descriptor in the Capacity Configuration List; or
b) the Selected Configuration field of the Media Unit Status log page (refer to Figure 255) is not cleared

to 0h,


then the controller shall abort the command with a status code of Invalid Field in Command and no changes
shall be made to the configuration of any Media Unit.


**Endurance Group Operations**


If the Operation field specifies the Create Endurance Group operation, the controller shall select a non-zero
Endurance Group Identifier not assigned to an existing Endurance Group in the specified domain (refer to
Figure 157) and indicate that value in Dword 0 of the completion queue entry (refer to Figure 161). If a nonzero unassigned Endurance Group Identifier is unavailable, then the controller shall abort the command
with a status code of Identifier Unavailable.


If the Operation field specifies the Create Endurance Group operation and Media Units are supported, then
the controller selects Media Units from the specified domain to be allocated to the Endurance Group.


If the Operation field specifies the Create Endurance Group operation and Media Units are not supported,
then the controller selects NVM capacity from the specified domain to be allocated to the Endurance Group.


If the Operation field specifies the Create Endurance Group operation and the Capacity Lower and Capacity
Upper fields specify a value that requires allocation of NVM capacity that is greater than the value in:


180


NVM Express [®] Base Specification, Revision 2.2


a) the Max Endurance Group Capacity (MEGCAP) field in the Identify Controller data structure;
b) the Unallocated NVM Capacity (UNVMCAP) field in the Identify Controller data structure; or
c) the Max Endurance Group Capacity (MEGCAP) field in the Domain Attributes Entry for the domain

in which the Endurance Group is being created,


then the controller:


a) shall abort the command with Insufficient Capacity status; and
b) if the Error Information log page is supported, shall indicate in the Command Specific Information

field in the Error Information Log Entry data structure (refer to Figure 206) the total amount of NVM
capacity in bytes of the largest Endurance Group that is able to be created.


If the Operation field specifies the Delete Endurance Group operation and the Element Identifier field
specifies a value of 0h or the identifier of an Endurance Group that does not exist, then the controller shall
abort the command with a status code of Invalid Field in Command.


**NVM Set Operations**


If the Operation field specifies the Create NVM Set operation, the controller shall select a non-zero NVM
Set Identifier not assigned to an existing NVM Set in the specified Endurance Group (refer to Figure 157)
and indicate that value in the completion queue entry. If a non-zero unassigned NVM Set Identifier is
unavailable, then the controller shall abort the command with a status code of Identifier Unavailable.


If the Operation field specifies the Create NVM Set operation and the Capacity Lower and Capacity Upper
fields specify a value that requires allocation of NVM capacity that is greater than the value in the
Unallocated Endurance Group Capacity (UEGCAP) field in the Endurance Group Information log page
(refer to Figure 219) for the specified Endurance Group, then the controller:


a) if the Error Information log page is supported, shall indicate in the Command Specific Information

field in the Error Information Log Entry data structure (refer to Figure 206) the total amount of NVM
capacity in bytes of the largest NVM Set that is able to be created; and
b) shall abort the command with Insufficient Capacity status.


If the Operation field specifies the Create NVM Set operation and the Element Identifier field is cleared to
0h, then the controller shall choose an existing Endurance Group in an existing domain in which to create
the NVM Set.


If the Operation field specifies the Create NVM Set operation and Media Units are supported, then the
controller selects Media Units from the Endurance Group to be allocated to the NVM Set.


If the Operation field specifies the Create NVM Set operation and Media Units are not supported, then the
controller selects NVM capacity from the Endurance Group to be allocated to the NVM Set.


If the Operation field specifies the Delete NVM Set operation and the Element Identifier field specifies a
value of 0h or the identifier of an NVM Set that does not exist, then the controller shall abort the command
with a status code of Invalid Field in Command.


If the controller does not support NVM Sets and the Operation field specifies either the Create NVM Set
operation or the Delete NVM Set operation, then the controller shall abort the command with a status code
of Invalid Field in Command.


**Command Completion**


Upon completion of the Capacity Management command, the controller posts a completion queue entry to
the Admin Completion Queue. Capacity Management command specific status values are defined in Figure
160.


181


NVM Express [®] Base Specification, Revision 2.2


**Figure 160: Capacity Management – Command Specific Status Values**

|Value|Definition|
|---|---|
|26h|**Insufficient Capacity:** The requested operation requires more free space than is currently available. The<br>Command Specific Information field in the Error Information Log Entry data structure (refer to Figure 206)<br>specifies the total amount of NVM capacity in bytes required to create the Endurance Group or NVM Set.|
|2Dh|**Identifier Unavailable:**The number of Endurance Groups or NVM Sets supported has been exceeded.|



Dword 0 of the completion queue entry contains the identifier of the Endurance Group or NVM Set created,
if any. Completion queue entry Dword 0 is defined in Figure 161.


**Figure 161: Capacity Management – Completion Queue Entry Dword 0**






|Bits|Description|
|---|---|
|31:16|Reserved|
|15:00|**Created Element Identifier (CELID):**This field indicates the identifier of the NVM Set that was created<br>if the Create NVM Set operation was used.<br>This field indicates the identifier of the Endurance Group Identifier if the Create Endurance Group<br>operation was used.<br>This field is reserved for all other operations.|