
**Firmware Image Download command**


The Firmware Image Download command is used to download all or a portion of an image for a future
update to the controller. The Firmware Image Download command may be submitted while other
commands on the Admin Submission Queue or I/O Submission Queues are outstanding. The Firmware
Image Download command downloads a new image (in whole or in part) to the controller.


The image may be constructed of multiple pieces that are individually downloaded with separate Firmware
Image Download commands. Each Firmware Image Download command includes a Dword Offset and
Number of Dwords that specify a dword range. The host software should ensure that image pieces do not
have dword ranges that overlap and that the NUMD field and OFST field meet the alignment and granularity
requirements indicated in the FWUG field (refer to Figure 313). Firmware portions may be submitted out of
order to the controller. Host software shall submit image portions in order when updating a Boot Partition.
If ranges overlap, the controller may return an error of Overlapping Range.


The new firmware image is not activated as part of the Firmware Image Download command. Refer to
section 3.11 for details on the firmware update process. The firmware update process does not modify the
contents of Boot Partitions. Refer to section 8.1.3.2 for details on the Boot Partition update process.


Host software should not overlap command sequences that update Boot Partitions and/or firmware images
(refer to section 3.11 and section 8.1.3.2).


After downloading an image, host software issues a Firmware Commit command before downloading
another image. Processing of the first Firmware Image Download command after completion of a Firmware
Commit command shall cause the controller to discard all remaining portion(s), if any, of downloaded


191


NVM Express [®] Base Specification, Revision 2.2


images. If a Controller Level Reset occurs between a firmware download and completion of the Firmware
Commit command, then the controller shall discard all portion(s), if any, of downloaded images.


The Firmware Image Download command uses the Data Pointer, Command Dword 10, and Command
Dword 11 fields. All other command specific fields are reserved.


**Figure 185: Firmware Image Download – Data Pointer**

|Bits|Description|
|---|---|
|127:00|**Data Pointer (DPTR):**This field specifies the location where data should be transferred from. Refer to<br>Figure 92 for the definition of this field.|



**Figure 186: Firmware Image Download – Command Dword 10**





|Bits|Description|
|---|---|
|31:00|**Number of Dwords (NUMD):**This field specifies the number of dwords to transfer for this portion of the<br>firmware. This is a 0’s based value. If the value specified in this field does not meet the requirement<br>indicated by the FWUG field (refer to Figure 313), then the controller may abort the command with a<br>status code of Invalid Field in Command.|


**Figure 187: Firmware Image Download – Command Dword 11**







|Bits|Description|
|---|---|
|31:00|**Offset (OFST):**This field specifies the number of dwords offset from the start of the firmware image<br>being downloaded to the controller. The offset is used to construct the complete firmware image when<br>the firmware is downloaded in multiple pieces. The piece corresponding to the start of the firmware image<br>shall have an Offset of 0h. If the value specified in this field does not meet the requirement indicated by<br>the FWUG field (refer to Figure 313), then the controller may abort the command with a status code of<br>Invalid Field in Command.|


**Command Completion**



Upon completion of the Firmware Image Download command, the controller posts a completion queue
entry to the Admin Completion Queue. Firmware Image Download command specific status values are
defined in Figure 188.


**Figure 188: Firmware Image Download – Command Specific Status Values**






|Value|Definition|
|---|---|
|14h|**Overlapping Range:** This error is indicated if the controller detects that the firmware image has<br>overlapping ranges. This error may indicate that the granularity or alignment of the firmware image<br>downloaded does not conform to the Firmware Update Granularity field indicated in the Identify<br>Controller data structure.|



If the controller detects overlapping firmware/boot partition image update command sequences (refer to
section 1.5.41) of more than one firmware image and/or Boot Partition or the use of more than one controller
and/or Management Endpoint to update a single firmware image, then the results of that detection are
reported in Dword 0 of the completion queue entry as defined in Figure 183. Refer to section 3.11 and
section 8.1.3.2.