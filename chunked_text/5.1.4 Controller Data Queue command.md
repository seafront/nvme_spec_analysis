**Controller Data Queue command**


The Controller Data Queue command is used to manage queues in host memory that a controller posts a
specific type of data (refer to section 8.1.6).


The Controller Data Queue command uses the Command Dword 10 field. The use of the PRP1 field,
Command Dword 11 field, and Command Dword 12 field is specific to the management operation specified
by the Select field . All other command specific fields are reserved.


The Select field defined in Figure 162 determines which management operation is to be performed by this
command and refer to section 5.1.4.1 for a description of each management operation.


**Figure 162: Controller Data Queue – Command Dword 10**





|Bits|Description|
|---|---|
|31:16|**Management Operation Specific (MOS):**The definition of this field is specific to a management operation<br>(refer to the Select field). If a management operation does not define the use of this field, then this field is<br>reserved.|
|15:08|Reserved|
|07:00|**Select (SEL):**This field specifies the type of management operation to perform.<br>**Value**<br>**Management Operation**<br>**Reference Section**<br>0h<br>Create Controller Data Queue<br>5.1.4.1.1<br>1h<br>Delete Controller Data Queue<br>5.1.4.1.2<br>2h to BFh<br>Reserved<br>C0h to FFh<br>Vendor Specific|


|Value|Management Operation|Reference Section|
|---|---|---|
|0h|Create Controller Data Queue|5.1.4.1.1|
|1h|Delete Controller Data Queue|5.1.4.1.2|
|2h to BFh|Reserved|Reserved|
|C0h to FFh|Vendor Specific|Vendor Specific|


**Controller Data Queue Management Operations**



**5.1.4.1.1** **Create Controller Data Queue (Management Operation 0h)**


The Create Controller Data Queue management operation of the Controller Data Queue command is used
to create a queue in host memory to which a controller posts the information specified by the Queue Type
field (refer to Figure 166).


The Create Controller Data Queue management operation uses the PRP Entry 1 field, Command Dword
11 field, and Command Dword 12 field.


182


NVM Express [®] Base Specification, Revision 2.2


If a PRP List is provided to describe the Controller Data Queue, then the PRP List shall be maintained by
the host at the same location in host physical memory and the values in the PRP List shall not be modified
until the Controller Data Queue is deleted (refer to section 5.1.4.1.2) or the controller is reset. If the PRP
List values are modified, then the behavior is undefined.


If the number of memory ranges specified by the PRP Entry 1 field is greater than the value defined by the
Maximum CDQ Memory Ranges (MCMR) field in the Identify Controller data structure (refer to Figure 313),
then the controller shall abort the command with a status code of Invalid Field in Command.


If the number of memory ranges specified by the PRP Entry 1 field plus the number of memory ranges that
exists for all of the Controller Data Queues in the NVM subsystem is greater than the value defined by the
NVM Subsystem Maximum Controller CDQ Memory Ranges (NMCMR) field in the Identify Controller data
structure (refer to Figure 313), then the controller shall abort the command with a status code of Invalid
Field in Command.


If the current number of User Data Migration Queues that exist in the controller is equal to the value in the
Maximum Controller User Data Migration Queues (MCUDMQ) field in the Identify Controller data structure,
then the controller shall abort the command with a status code of Invalid Field in Command.


If the current number of User Data Migration Queues that exist in the NVM subsystem is equal to the value
in the Maximum NVM Subsystem User Data Migration Queues (MNSUDMQ) field in the Identify Controller
data structure, then the controller shall abort the command with a status code of Invalid Field in Command.


**Figure 163: Create Controller Data Queue – PRP Entry 1**





|Bits|Description|
|---|---|
|63:00|**PRP Entry 1 (PRP1):**If the PC bit is set to ‘1’, then this field specifies a 64-bit base host memory (refer to<br>section 1.5.46) address pointer of the Controller Data Queue that is physically contiguous. The address<br>pointer is memory page aligned (based on the value in CC.MPS field) unless otherwise specified. If the PC<br>bit (refer to Figure 164) is cleared to ‘0’, then this field specifies a PRP List pointer that describes the list of<br>pages that constitute the Controller Data Queue. The list of pages is host memory (refer to section 1.5.46)<br>that is page aligned (based on the value in CC.MPS field) unless otherwise specified. In both cases the PRP<br>Entry shall have an offset of 0h. In a non-contiguous Controller Data Queue, each PRP Entry in the PRP<br>List shall have an offset of 0h. If there is a PRP Entry with a non-zero offset, then the controller shall return<br>an error of PRP Offset Invalid.<br>If the memory specified by this field is not host memory (e.g., CMB or PMR), then the controller shall abort<br>the command with a status code of Invalid Field in Command.|


**Figure 164:** **Create Controller Data Queue – Command Dword 11**







|Bits|Description|
|---|---|
|31:16|**Create Queue Specific (CQS):**The definition of this field is specific to the type of queue being created<br>(refer to Queue Type (QT) field in Figure 166). If the type of queue being created does not define the use of<br>this field, then this field is reserved.|
|15:01|Reserved|
|00|**Physically Contiguous (PC):**If set to ‘1’, then the Controller Data Queue is physically contiguous and PRP<br>Entry 1 (PRP1) is the address of a contiguous physical buffer. If cleared to ‘0’, then the Controller Data<br>Queue is not physically contiguous and PRP Entry 1 (PRP1) is a PRP List pointer.|


**Figure 165:** **Create Queue – Command Dword 12**



|Bits|Description|
|---|---|
|31:00|**Controller Data Queue Size (CDQSIZE):**This field specifies the size of the queue to be created in dwords.|


If the Controller Data Queue Size field value is not a multiple of the size of the entries for the type of
Controller Data Queue as specified by the Queue Type field (refer to Figure 166), then the controller shall
abort the command with a status code of Invalid Field in Command.


183


NVM Express [®] Base Specification, Revision 2.2


The Management Operation Specific field (refer to Figure 162) for the Create Controller Data Queue
management operation is specified in Figure 166.


**Figure 166:** **Create Controller Data Queue – Management Operation Specific**






|Bits|Description|
|---|---|
|15:08|Reserved|
|07:00|**Queue Type (QT):**This field specifies the type of queue to be created which defines the information that<br>the controller posts into the entries of the queue.<br>**Value**<br>**Definition**<br>**Reference Section**<br>0h<br>User Data Migration Queue<br>5.1.4.1.1.1<br>1h to BFh<br>Reserved<br>C0h to FFh<br>Vendor Specific|


|Value|Definition|Reference Section|
|---|---|---|
|0h|User Data Migration Queue|5.1.4.1.1.1|
|1h to BFh|Reserved|Reserved|
|C0h to FFh|Vendor Specific|Vendor Specific|



If the PRP Entry 1 field has a non-zero PRP offset, then the controller shall abort the command with a status
code of PRP Offset Invalid.


**User Data Migration Queue (Queue Type 0h)**


The User Data Migration Queue of the Controller Data Queue command is used to create a queue for
logging of user data modified during the migration of the controller specified by the Controller Identifier field
as defined by Figure 167.


If a User Data Migration Queue is associated with the same controller specified by the Controller Identifier
field (refer to Figure 167), then the controller shall abort the command with a status code of Invalid Field in
Command.


If the number of User Data Migration Queues that exist in the controller is equal to the value defined in the
Maximum Controller User Data Migration Queues (MCUDMQ) field in the Identify Controller data structure
(refer to Figure 313), then the controller shall abort this command with a status code of Not Enough
Resources.


If the number of User Data Migration Queues that exist in the NVM subsystem is equal to the value defined
in the Maximum NVM Subsystem User Data Migration Queues (MNSUDMQ) field in the Identify Controller
data structure (refer to Figure 313), then the controller shall abort this command with a status code of Not
Enough Resources.


**Figure 167:** **User Data Migration Queue – Create Queue Specific**

|Bits|Description|
|---|---|
|15:00|**Controller Identifier (CNTLID):**This field specifies the controller associated with the information contained<br>in the User Data Migration Queue.|



Refer to the applicable I/O Command Set specification for the requirements and formats of the entries for
the User Data Migration Queue.


**5.1.4.1.2** **Delete Controller Data Queue (Management Operation 1h)**


The Delete Controller Data Queue management operation of the Controller Data Queue command is used
to delete a CDQ.


The Delete Controller Data Queue management operation uses the Command Dword 11 field.


**Figure 168:** **Delete Controller Data Queue – Command Dword 11**

|Bits|Description|
|---|---|
|31:16|Reserved|
|15:00|**Controller Data Queue Identifier (CDQID):** This field specifies the identifier (refer to Figure 169) of the<br>existing User Data Migration Queue to delete.|



184


NVM Express [®] Base Specification, Revision 2.2


If the value in the Controller Data Queue Identifier field specifies a CDQ that does not exist in the controller
processing the command, then the controller shall abort the command with a status code of Invalid
Controller Data Queue.


**Command Completion**


Upon completion of the Controller Data Queue command, the controller posts a completion queue entry to
the Admin Completion Queue indicating the status for the command. Section 5.1.4.1 describes completion
details for each management operation.


If a status code of Successful Completion is returned for the Create Controller Data Queue management
operation, then Dword 0 of the completion queue entry contains the identifier of the Controller Data Queue
created as defined in Figure 169. The indicated identifier is unique to the controller that processed the
command.


**Figure 169:** **Controller Data Queue – Completion Queue Entry Dword 0**

|Bits|Description|
|---|---|
|31:16|Reserved|
|15:00|**Controller Data Queue Identifier (CDQID):**This field indicates the identifier for the Controller Data<br>Queue created (refer to section 8.1.6).|



Controller Data Queue command specific status values (i.e., SCT field set to 1h) are shown in Figure 170.


**Figure 170: Controller Data Queue – Command Specific Status Values**

|Value|Definition|
|---|---|
|1Fh|**Invalid Controller Identifier:**The Controller Identifier field contains an invalid value.|
|37h|**Invalid Controller Data Queue:** This error indicates that the specified Controller Data Queue Identifier<br>is invalid for the controller processing the command.|
