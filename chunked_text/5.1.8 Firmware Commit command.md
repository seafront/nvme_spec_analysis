
**Firmware Commit command**


Note: This command was known in NVM Express Base Specification revisions prior to revision 1.2 as
“Firmware Activate.”


The Firmware Commit command is used to modify the firmware image or Boot Partitions.


When modifying a firmware image, the Firmware Commit command verifies that a valid firmware image
has been downloaded and commits that revision to a specific firmware slot. The host may select the
firmware image to activate on the next Controller Level Reset as part of this command. The host may
determine the currently executing firmware revision by examining the Firmware Revision field in the Identify
Controller data structure in Figure 313. The host may determine the firmware revision to be executed on
the next Controller Level Reset by examining the Firmware Slot Information log page. All controllers in a
domain share firmware slots and the same firmware image is applied to all controllers in that domain (i.e.,
all the controllers in the NVM subsystem if multiple domains are not supported or all the controllers in that
domain if multiple domains are supported).


Activation of a firmware image may result in a change in controller behavior that is not expected by the host
(e.g., an incompatible change in the UUID List (refer to section 8.1.28.2)). In this case, if the Commit Action
field is set to 011b, then the controller shall abort the command with a status code of Firmware Activation
Requires Conventional Reset.


When modifying Boot Partitions, the host may select the Boot Partition to mark as active or to replace. A
Boot Partition is only able to be written when write unlocked (refer to section 8.1.3).


The Firmware Commit command uses the Command Dword 10 field. All other command specific fields are
reserved.


**Figure 182: Firmware Commit – Command Dword 10**





|Bits|Description|
|---|---|
|31|**Boot Partition ID (BPID):**Specifies the Boot Partition that shall be used for the Commit Action, if<br>applicable.|
|30:06|Reserved|
|05:03|**Commit Action (CA):**This field specifies the action that is taken (refer to section 3.11) on the image<br>downloaded with the Firmware Image Download command or on a previously downloaded and placed<br>image. The actions are indicated in the following table. <br>**Value**<br>**Definition**<br>000b<br>Downloaded image replaces the existing image, if any, in the specified Firmware<br>Slot. The newly placed image is not activated.<br>001b<br>Downloaded image replaces the existing image, if any, in the specified Firmware<br>Slot. The newly placed image is activated at the next Controller Level Reset.<br>010b<br>The existing image in the specified Firmware Slot is activated at the next Controller<br>Level Reset.<br>011b<br>Downloaded image replaces the existing image, if any, in the specified Firmware<br>Slot and is then activated immediately. If there is not a newly downloaded image,<br>then the existing image in the specified firmware slot is activated immediately. The<br>Firmware Commit command remains in progress until image activation has<br>completed successfully or unsuccessfully (i.e., the Firmware Commit command is<br>not a background operation).<br>100b to 101b<br>Reserved<br>110b<br>Downloaded image replaces the Boot Partition specified by the Boot Partition ID<br>field.<br>111b<br>Mark the Boot Partition specified in the BPID field as active and update<br>BPINFO.ABPID.|


|Value|Definition|
|---|---|
|000b|Downloaded image replaces the existing image, if any, in the specified Firmware<br>Slot. The newly placed image is not activated.|
|001b|Downloaded image replaces the existing image, if any, in the specified Firmware<br>Slot. The newly placed image is activated at the next Controller Level Reset.|
|010b|The existing image in the specified Firmware Slot is activated at the next Controller<br>Level Reset.|
|011b|Downloaded image replaces the existing image, if any, in the specified Firmware<br>Slot and is then activated immediately. If there is not a newly downloaded image,<br>then the existing image in the specified firmware slot is activated immediately. The<br>Firmware Commit command remains in progress until image activation has<br>completed successfully or unsuccessfully (i.e., the Firmware Commit command is<br>not a background operation).|
|100b to 101b|Reserved|
|110b|Downloaded image replaces the Boot Partition specified by the Boot Partition ID<br>field.|
|111b|Mark the Boot Partition specified in the BPID field as active and update<br>BPINFO.ABPID.|


189


NVM Express [®] Base Specification, Revision 2.2


**Figure 182: Firmware Commit – Command Dword 10**







|Bits|Description|
|---|---|
|02:00|**Firmware Slot (FS):**Specifies the firmware slot that shall be used for the Commit Action, if applicable.<br>If the value specified is 0h, then the controller shall choose the firmware slot (i.e., slot 1 to slot 7) to use<br>for the operation.|


**Command Completion**



Upon completion of the Firmware Commit command, the controller posts a completion queue entry to the
Admin Completion Queue indicating the status for the command.


For Firmware Commit commands that specify activation of a new firmware image at the next Controller
Level Reset (i.e., the CA field was set to 001b or 010b) and complete with a status code value of 0h (i.e.,
Success Completion), a Controller Level Reset initiated by any of the methods defined in section 3.7.2
activates the specified firmware.


If the controller detects overlapping firmware/boot partition image update command sequences (refer to
section 1.5.41) of more than one firmware image and/or Boot Partition or the use of more than one controller
and/or Management Endpoint to update a single firmware image, then the results of that detection are
reported in Dword 0 of the completion queue entry as defined in Figure 183. Refer to section 3.11 and
section 8.1.3.2.


If:


a) the Commit Action field is cleared to 000b (i.e., update the firmware image in the specified firmware

slot but do not activate);
b) the Firmware Slot field is set to the active firmware slot (refer to Figure 209); and
c) the controller supports greater than one firmware slot for a host to store firmware images,


then the controller may abort the command with a status code of Command Sequence Error. A host may
avoid this result by using a different firmware slot.


**Figure 183: Firmware Commit – Completion Queue Entry Dword 0**








|Bits|Description|
|---|---|
|31:02|Reserved|
|01:00|**Multiple Update Detected (MUD):** This field indicates if a controller detected overlapping firmware/boot<br>partition image update command sequences of Boot Partitions and/or firmware images (refer to section<br>3.11 and section 8.1.3.2). If the SMUD bit in the Firmware Update field of the Identify Controller data<br>structure is cleared to ‘0’, then this field shall be cleared to 00b.<br>This field is valid if the command is successful or aborted.<br>**Bits**<br>**Description**<br>1 <br>**Management Endpoint FW Overlap (MEFWO):**If this bit is set to ‘1’, then the controller<br>detected an overlapping firmware/boot partition image update command sequence due to<br>processing a command from a Management Endpoint. If this bit is cleared to ‘0’, then the<br>controller did not detect an overlapping firmware/boot partition image update command<br>sequence due to processing a command from a Management Endpoint.<br>0 <br>**Admin Submission Queue FW Overlap (ASQFWO):**If this bit is set to ‘1’, then the<br>controller detected an overlapping firmware/boot partition image update command sequence<br>due to processing a command from an Admin Submission Queue on a controller. If this bit<br>is cleared to ‘0’, then the controller did not detect an overlapping firmware/boot partition<br>image update command sequence due to processing a command from an Admin<br>Submission Queue on a controller.|


|Bits|Description|
|---|---|
|1|**Management Endpoint FW Overlap (MEFWO):**If this bit is set to ‘1’, then the controller<br>detected an overlapping firmware/boot partition image update command sequence due to<br>processing a command from a Management Endpoint. If this bit is cleared to ‘0’, then the<br>controller did not detect an overlapping firmware/boot partition image update command<br>sequence due to processing a command from a Management Endpoint.|
|0|**Admin Submission Queue FW Overlap (ASQFWO):**If this bit is set to ‘1’, then the<br>controller detected an overlapping firmware/boot partition image update command sequence<br>due to processing a command from an Admin Submission Queue on a controller. If this bit<br>is cleared to ‘0’, then the controller did not detect an overlapping firmware/boot partition<br>image update command sequence due to processing a command from an Admin<br>Submission Queue on a controller.|



Firmware Commit command specific status values (i.e., SCT field set to 1h) are shown in Figure 184.


190


NVM Express [®] Base Specification, Revision 2.2


**Figure 184: Firmware Commit – Command Specific Status Values**







|Value|Definition|
|---|---|
|06h|**Invalid Firmware Slot:**The firmware slot indicated is invalid or read only. This error is indicated if the<br>firmware slot exceeds the number supported.|
|07h|**Invalid Firmware Image:**The firmware image specified for activation is:<br>• <br>invalid and not loaded by the controller; or <br>• <br>the specified firmware slot does not contain a firmware image.|
|0Bh|**Firmware Activation Requires Conventional Reset:**The firmware commit was successful; however,<br>activation of the firmware image requires a Conventional Reset. (refer to the NVM Express NVMe over<br>PCIe Transport Specification). If a Function Level Reset (refer to the NVM Express NVMe over PCIe<br>Transport Specification) or Controller Reset occurs prior to a Conventional Reset, the controller shall<br>continue operation with the currently executing firmware image.|
|10h|**Firmware Activation Requires NVM Subsystem Reset:**The firmware commit was successful;<br>however, activation of the firmware image requires an NVM Subsystem Reset. If any other type of<br>Controller Level Reset occurs prior to an NVM Subsystem Reset, the controller shall continue operation<br>with the currently executing firmware image.|
|11h|**Firmware Activation Requires Controller Level Reset:** The firmware commit was successful; however,<br>the firmware image specified does not support being activated without a Controller Level Reset. The<br>firmware image shall be activated at the next Controller Level Reset. This status code should be returned<br>only if the Commit Action field in the Firmware Commit command is set to 011b (i.e., activate immediately).|
|12h|**Firmware Activation Requires Maximum Time Violation:**The firmware commit was successful;<br>however, the firmware image was not activated. Activation of the specified firmware image requires more<br>time than the amount indicated in the Maximum Time for Firmware Activation (MTFA) field in the Identify<br>Controller data structure (refer to Figure 313). To activate the firmware image committed to the specified<br>firmware slot, a Firmware Commit command specifying a Commit Action set to 010b may be issued as<br>described in section 3.11.|
|13h|**Firmware Activation Prohibited:** The image specified is being prohibited from activation by the<br>controller for vendor specific reasons (e.g., controller does not support down revision firmware).|
|14h|**Overlapping Range**: This error is indicated if the controller detects that the firmware image has<br>overlapping ranges.|
|1Eh|**Boot Partition Write Prohibited:**This error is indicated if a command attempts to modify a Boot Partition<br>while write locked (refer to section 8.1.3.3).|